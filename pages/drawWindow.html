<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../photon-0.1.2-dist/css/photon.min.css">
    <style>
        body.busy-cursor {
            cursor: url('../cursor-pen.png'), auto;
        }
        body {
            background-color: #f5f5f4;
        }

        .content{
            display:flex;
            flex-direction: row;
            /*flex-wrap: wrap;*/
            justify-content: space-around;
            align-items: center;
        }

        .components{
            border-style: solid;
            margin: 10px;
        }

        .elements {
            border-style: solid;
            margin: 10px;
            padding: 5px;
        }

        #toolBox{
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: center;
        }

        button{
            height: 30px;
            width: 30px;
        }

        .img-icon{
            padding: 0.2em 0.3em;
        }
        .img-icon > img{
            vertical-align: middle;
        }

        #canvas{
            background-color: white;
            box-shadow: 5px 5px 5px black;
            border-style: solid;
            border-width: thin;
            margin: 20px;
        }
    </style>
</head>
<body>
    <div class="content">
        <div id="toolBox">
            <button id="bezierPencil" type="button" title="Draw a Bezier curve" class="btn btn-default img-icon">
                <img width="20" src="../UI/img/bezier.png">
            </button>
            <button type="button" title="Draw lines" class="btn btn-default img-icon">
                <img width="20"  src="../UI/img/line.svg">
            </button>
            <button type="button" title="Draw circle" class="btn btn-default img-icon">
                <img width="20"  src="../UI/img/circle.svg">
            </button>
            <button type="button" title="Draw square" class="btn btn-default img-icon">
                <img width="20"  src="../UI/img/square.svg">
            </button>
            <button type="button" title="Freehand drawing" class="btn btn-default img-icon">
                <img width="20"  src="../UI/img/pencil.svg">
            </button>
            <button type="button" title="Erase existing paths" class="btn btn-default img-icon">
                <img width="20"  src="../UI/img/eraser.svg">
            </button>
            <button type="button" title="Create spirals" class="btn btn-default img-icon">
                <img width="20"  src="../UI/img/spiral.svg">
            </button>
        </div>
        <div style="display:flex; flex-direction: column;">
            <div style="display:flex; flex-direction: row;">
                <div style="display:flex; flex-direction: column;justify-content: space-between;height:650px;padding-bottom:3%;padding-top:3%;">
                    <div>y max: <input id="ymax" type="number" style="width: 40px;"></div>
                    <div>y min: <input id="ymin" type="number" style="width: 40px;"></div>
                </div>
                <div style="display:flex; flex-direction: column;">
                    <id id="canvas"></id>
                    <div style="display:flex; flex-direction: row;justify-content: space-between;align-items: center;">
                        <div>x min: <input id="xmin" type="number" style="width: 40px;"></div>
                        <div>x max:<input id="xmax" type="number" style="width: 40px;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="panelControl" class="components">
            <div class="elements">
                <button type="button">New button</button>
            </div>
        </div>
    </div>
    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>
    <script src="../lib/jquery-3.2.1.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <script src="../lib/d3.v5.min.js"></script>
    <script>
        let Bezier = require("./drawWindow.js");
        let DataGen = require("../datagen/datagen.js");
        let ipc = require('electron').ipcRenderer;
        let control_points = [];
        let previewPath = [];
        let selectingPath = [];
        let getPoints = false;
        let aux = [];
        let distance = 0;
        let theta_radians = 0;
        let selectedPath = 0;
        let drawings = [];

        $("input#xmin").val(0);
        $("input#xmax").val(1);
        $("input#ymin").val(0);
        $("input#ymax").val(1);

        let xScale = d3.scaleLinear()
            .domain([$("input#xmin").val(), $("input#xmax").val()])
            .range([30, 800]);

        let yScale = d3.scaleLinear()
            .domain([$("input#ymin").val(), $("input#ymax").val()])
            .range([600, 25]);

        let svg2 = d3.select("#canvas")
            .append("svg")
            .attr("width", 850)
            .attr("height", 650)
            .call(d3.drag()
                .on("start", function(){
                    if (getPoints){
                        aux = d3.mouse(this);
                    }
                })
                .on("drag", function(){
                    if (getPoints){
                        selectingPath = [];
                        selectingPath.push(previewPath[previewPath.length-2]);
                        selectingPath.push(previewPath[previewPath.length-1]);
                        selectingPath.push(pontoOposto(aux[0], aux[1], d3.mouse(this)[0], d3.mouse(this)[1]));
                        selectingPath.push(aux);
                        selectingPath.push(d3.mouse(this));
                        update();
                    }
                })
                .on("end", function(){
                    if (getPoints){
                        if (previewPath.length > 0){
                            previewPath.push(pontoOposto(aux[0], aux[1], d3.mouse(this)[0], d3.mouse(this)[1]));
                        }

                        previewPath.push(aux);
                        previewPath.push(d3.mouse(this));
                        aux = [];
                        selectingPath = [];
                        update();
                    }
                }));

        let svg = svg2
            .append("g");

        svg.append("g")
            .attr("class", "xaxis")
            .attr("transform", "translate(0," + 600 + ")")
            .call(d3.axisBottom(xScale));

        svg.append("g")
            .attr("class", "yaxis")
            .attr("transform", "translate(" + 30 + ",0)")
            .call(d3.axisLeft(yScale));

        let strSelecting = "";
        svg.append('path').attr("id", "selecting").attr("d",strSelecting)
            .style("fill","none").style("stroke","red").style("opacity","0.3").style("stroke-width","2px");

        let strPreview = "";
        svg.append('path').attr("id", "preview").attr("d",strPreview)
            .style("fill","none").style("stroke","green").style("stroke-width","2px");

        let points_selection = svg.selectAll('circle.control').data(control_points);
        points_selection.exit().remove();


        update();
        function update(){
            svg.selectAll("circle").remove();
            svg.selectAll("path.definitive").remove();
            svg.selectAll(".lineGuide").remove();

            drawings.forEach(function(e,i){
                svg.append(function(){return e.getPath();});
            });

            /*control_points.forEach(function(e,i){
                let str = "";
                if (e.length > 0){//Primeiro ponto
                    str = "M "+e[0][0]+","+e[0][1]+" C";
                    let line;
                    let middle = e[0], anchor1 = e[1];
                    line = "M "+middle[0]+","+middle[1]+" L"+anchor1[0]+","+anchor1[1];

                    svg.append('path').attr("class", "lineGuide").attr("d",line)
                        .style("stroke","red").style("stroke-width","1px");
                }

                for(let i=1; i<e.length; i++){//Pontos do meio
                    str += " "+e[i][0]+","+e[i][1];

                    if (i%3 === 0 && i<e.length-1){
                        let line;
                        let middle = e[i], anchor1 = e[i+1], anchor2 = e[i-1];
                        line = "M "+middle[0]+","+middle[1]+" L"+anchor1[0]+","+anchor1[1];
                        line += "M "+anchor2[0]+","+anchor2[1]+" L"+middle[0]+","+middle[1];

                        svg.append('path').attr("class", "lineGuide").attr("d",line)
                            .style("stroke","red").style("stroke-width","1px");
                    }

                    if (i === e.length-1){//Ãšltimo ponto
                        let line;
                        let middle = e[e.length-1], anchor1 = e[e.length-2];
                        line = "M "+middle[0]+","+middle[1]+" L"+anchor1[0]+","+anchor1[1];

                        svg.append('path').attr("class", "lineGuide").attr("d",line)
                            .style("stroke","red").style("stroke-width","1px");
                    }
                }

                /*svg.append('path').attr("class", "definitive").attr("id", i).attr("d",str)
                    .style("fill","none").style("stroke","black").style("stroke-width","3px")
                    .call(d3.drag()
                        .on("start", function(d){
                            selectedPath = this.id;
                        })
                        .on("drag", function(d){

                        })
                        .on("end", function(d){

                        }));

                svg.selectAll("circle.control")
                    .data(e)
                    .enter().append("svg:circle")
                    .attr("fill", "blue")
                    .attr("r", 3)
                    .attr("cx", function (d) { return d[0]; })
                    .attr("cy", function (d) { return d[1]; })
                    .call(d3.drag()
                        .on("start", function(d,i) {
                            distance = Math.sqrt(Math.pow((e[i-1][0] - e[i][0]),2) + Math.pow((e[i-1][1] - e[i][1]),2));

                            let delta_x = e[i-1][0] - e[i][0];
                            let delta_y = e[i-1][1] - e[i][1];
                            theta_radians = Math.atan2(delta_y, delta_x);
                        })
                        .on("drag", function(d,i) {
                            svg.selectAll(".lineGuide").remove();
                            e[i][0] = d3.event.x;
                            e[i][1] = d3.event.y;

                            let j = 0;
                            if(i % 3 === 1){
                                j = i-1;
                                e[j-1] = pontoOposto(e[j][0], e[j][1], e[i][0], e[i][1]);
                            }else if(i % 3 === 2){
                                j = i+1;
                                if(j+1 < e.length) e[j+1] = pontoOposto(e[j][0], e[j][1], e[i][0], e[i][1]);
                            }else{
                                let x3 = e[i][0] + (distance * Math.cos(theta_radians));
                                let y3 = e[i][1] + (distance * Math.sin(theta_radians));
                                e[i-1] = [x3,y3];

                                if(i+1 < e.length) e[i+1] = pontoOposto(e[i][0], e[i][1], e[i-1][0], e[i-1][1]);
                            }

                            update();
                        })
                        .on("end", function(d,i) {
                            ipc.send('get-path2', getPath());
                        }));
            });*/

            let strSelecting = "";
            if (selectingPath.length > 0)
                strSelecting = "M "+selectingPath[0][0]+","+selectingPath[0][1]+" C";

            for(let i=1; i<selectingPath.length; i++){
                strSelecting += " "+selectingPath[i][0]+","+selectingPath[i][1];
            }

            let strPreview = "";
            if (previewPath.length > 0)
                strPreview = "M "+previewPath[0][0]+","+previewPath[0][1]+" C";

            for(let i=1; i<previewPath.length; i++){
                strPreview += " "+previewPath[i][0]+","+previewPath[i][1];
            }

            svg.select("path#selecting").attr("d",strSelecting);
            svg.select("path#preview").attr("d",strPreview);

            svg.selectAll("circle.selecting")
                .data(selectingPath)
                .enter().append("svg:circle")
                .attr("fill", "red")
                .attr("r", 3)
                .attr("cx", function (d) { return d[0]; })
                .attr("cy", function (d) { return d[1]; });

            svg.selectAll("circle.preview")
                .data(previewPath)
                .enter().append("svg:circle")
                .attr("fill", "green")
                .attr("r", 3)
                .attr("cx", function (d) { return d[0]; })
                .attr("cy", function (d) { return d[1]; });
        }

        function pontoOposto(x1,y1,x2,y2){
            let x3 = 0, y3 = 0;

            let d = Math.sqrt(Math.pow((x2 - x1),2) + Math.pow((y2 - y1),2));

            let delta_x = x2 - x1;
            let delta_y = y2 - y1;
            let theta_radians = Math.atan2(delta_y, delta_x);

            x3 = x1 + (d * Math.cos(theta_radians - Math.PI));
            y3 = y1 + (d * Math.sin(theta_radians - Math.PI));

            return [x3,y3];
        }

        $("#bezierPencil").on("click", function(){
            getPoints = true;
            //document.body.classList.add('busy-cursor');
        });
        $(document).keydown(function(event){
            let keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == '13'){//ENTER
                getPoints = false;
                previewPath.pop();
                control_points.push(previewPath);
                let b = new Bezier(previewPath);
                b.setOnStateChange(function(){
                    update();
                })
                drawings.push(b);
                previewPath = [];
                selectingPath = [];
                //document.body.classList.remove('busy-cursor');
                update();
                ipc.send('get-path2', getPath());
            }else if(keycode == '27'){//ESC
                getPoints = false;
                previewPath = [];
                selectingPath = [];
                document.body.classList.remove('busy-cursor');
                update();
            }else if (keycode == '46'){//DEL
                if (selectedPath >= 0){
                    control_points.splice(selectedPath, 1);
                    selectedPath = -1;
                    update();
                }
            }

        });

        $("input").change(function(){
            xScale.domain([$("input#xmin").val(),$("input#xmax").val()]);
            yScale.domain([$("input#ymin").val(),$("input#ymax").val()]);
            svg.select(".xaxis").call(d3.axisBottom(xScale));
            svg.select(".yaxis").call(d3.axisLeft(yScale));
        });

        function getPath(){
            let cp_scaled = [];
            control_points.forEach((e,i)=>{
                let t = [];
                for (let j = 0; j < e.length; j++){
                    t.push([xScale.invert(e[j][0]),yScale.invert(e[j][1])]);
                }
                cp_scaled.push(t);
            });

            let str = "";
            cp_scaled.forEach((e,i)=>{
                if (e.length > 0){
                    str += "M "+e[0][0]+","+e[0][1]+" C";
                }

                for(let i=1; i<e.length; i++){
                    str += " "+e[i][0]+","+e[i][1];
                }
            });

            return str;
        }

        ipc.on('open-window', function(event, message){
            let svgObj = DataGen.Utils.decodeSvgPathD(message.path);
            let greaterX = null, greaterY = null;
            let lowerX = null, lowerY = null;
            let output = [];

            svgObj.forEach((e,i) => {
                for (let j = 0; j < e.params.length; j += 2){
                    if (e.params[j] > greaterX || greaterX === null){
                        greaterX = e.params[j];
                    }else if (e.params[j] < lowerX || lowerX === null){
                        lowerX = e.params[j];
                    }

                    if (e.params[j+1] > greaterY || greaterY === null){
                        greaterY = e.params[j+1];
                    }else if (e.params[j+1] < lowerY || lowerY === null){
                        lowerY = e.params[j+1];
                    }
                }
            });

            $("input#xmin").val(Math.round(lowerX+1));
            $("input#xmax").val(Math.round(greaterX+1));
            $("input#ymin").val(Math.round(lowerY+1));
            $("input#ymax").val(Math.round(greaterY+1));

            xScale.domain([lowerX,greaterX]);
            yScale.domain([lowerY,greaterY]);
            svg.select(".xaxis").call(d3.axisBottom(xScale));
            svg.select(".yaxis").call(d3.axisLeft(yScale));

            svgObj.forEach((e,i) => {
                for (let j = 0; j < e.params.length; j += 2){
                    let x = xScale(e.params[j]), y = yScale(e.params[j+1]);
                    if (e.command === "L"){
                        //control_points.push(output);
                        drawings.push(new Bezier(output));
                        output = [];
                    }
                    output.push([x, y]);
                }
            });
            //control_points.push(output);
            drawings.push(new Bezier(output));

            update();
        });
    </script>
</body>
</html>