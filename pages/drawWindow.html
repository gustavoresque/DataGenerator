<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .components{
            border-style: solid;
            float:left;
            display:inline;
        }

        .elements {
            border-style: solid;
            margin: 10px;
            padding: 5px;
        }

        #canvas{
            height: 600px;
            width: 800px;
            position: relative;
        }
        #bezier{
            border-style: dashed;
            width: 600px;
            height: 400px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-right: -50%;
            transform: translate(-50%, -50%) }
        }
    </style>
</head>
<body>
    <div id="canvas" class="components">
        <div id="bezier"></div>
    </div>
    <div id="panelControl" class="components">
        <div class="elements" id="buttons">
            <button id="bezierPencil" type="button">BÃ©zier Pencil</button>
        </div>
        <div class="elements" id="properties">
            <button type="button">Click Me!</button>
        </div>
    </div>

    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>
    <script src="../lib/jquery-3.2.1.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <script src="../lib/d3.v5.min.js"></script>
    <script>

        let curves = [];
        let control_points = [], previewPath = [], selectingPath = [];
        let getPoints = false;
        let aux = [];

        let svg = d3.select("#bezier")
            .append("svg")
            .attr("width", 600)
            .attr("height", 400)
            .on('click', function(){
            })
            .call(d3.drag()
                .on("start", function(d) {
                    if (getPoints)
                        aux = d3.mouse(this);
                })
                .on("drag", function(d,i) {
                    if (getPoints){
                        selectingPath = [];
                        selectingPath.push(previewPath[previewPath.length-2]);
                        selectingPath.push(previewPath[previewPath.length-1]);
                        selectingPath.push(pontoOposto(aux[0], aux[1], d3.mouse(this)[0], d3.mouse(this)[1]));
                        selectingPath.push(aux);
                        selectingPath.push(d3.mouse(this));
                        update();
                    }
                })
                .on("end", function(d,i) {
                    if (getPoints){
                        if (previewPath.length > 0){
                            previewPath.push(pontoOposto(aux[0], aux[1], d3.mouse(this)[0], d3.mouse(this)[1]));
                        }

                        previewPath.push(aux);
                        previewPath.push(d3.mouse(this));
                        aux = [];
                        selectingPath = [];
                        update();
                    }
                }));

        let strSelecting = "";
        svg.append('path').attr("id", "selecting").attr("d",strSelecting)
            .style("fill","none").style("stroke","red").style("opacity","0.3").style("stroke-width","2px");

        let strPreview = "";
        svg.append('path').attr("id", "preview").attr("d",strPreview)
            .style("fill","none").style("stroke","green").style("stroke-width","2px");

        let points_selection = svg.selectAll('circle.control').data(control_points);
        points_selection.exit().remove();


        update();
        function update(){
            svg.selectAll("circle").remove();
            svg.selectAll("path.definitive").remove();

            control_points.forEach(function(e){
                let str = "";
                if (e.length > 0)
                    str = "M "+e[0][0]+","+e[0][1]+" C";

                for(let i=1; i<e.length; i++){
                    str += " "+e[i][0]+","+e[i][1];
                }

                svg.append('path').attr("class", "definitive").attr("d",str)
                    .style("fill","none").style("stroke","black").style("stroke-width","2px");

                svg.selectAll("circle.control")
                    .data(e)
                    .enter().append("svg:circle")
                    .attr("fill", "blue")
                    .attr("r", 3)
                    .attr("cx", function (d) { return d[0]; })
                    .attr("cy", function (d) { return d[1]; })
                    .call(d3.drag()
                        .on("start", function(d,i) {
                            console.log(i);
                        })
                        .on("drag", function(d,i) {
                            svg.selectAll("#lineGuide").remove();
                            e[i][0] = d3.event.x;
                            e[i][1] = d3.event.y;

                            let j = 0;
                            let line = "";
                            if(i % 3 === 1){
                                j = i-1;
                            }else if(i % 3 === 2){
                                j = i+1;
                            }else{
                                j = i;
                            }

                            console.log(i, j);

                            line = "M "+e[j][0]+","+e[j][1]+" L"+e[j+1][0]+","+e[j+1][1];
                            line += "M "+e[j-1][0]+","+e[j-1][1]+" L"+e[j][0]+","+e[j][1];

                            svg.append('path').attr("id", "lineGuide").attr("d",line)
                                .style("stroke","red").style("stroke-width","1px");

                            update();
                        })
                        .on("end", function(d,i) {
                            svg.selectAll("#lineGuide").remove();
                        }));
            });

            let strSelecting = "";
            if (selectingPath.length > 0)
                strSelecting = "M "+selectingPath[0][0]+","+selectingPath[0][1]+" C";

            for(let i=1; i<selectingPath.length; i++){
                strSelecting += " "+selectingPath[i][0]+","+selectingPath[i][1];
            }

            let strPreview = "";
            if (previewPath.length > 0)
                strPreview = "M "+previewPath[0][0]+","+previewPath[0][1]+" C";

            for(let i=1; i<previewPath.length; i++){
                strPreview += " "+previewPath[i][0]+","+previewPath[i][1];
            }

            svg.select("path#selecting").attr("d",strSelecting);
            svg.select("path#preview").attr("d",strPreview);

            svg.selectAll("circle.selecting")
                .data(selectingPath)
                .enter().append("svg:circle")
                .attr("fill", "red")
                .attr("r", 3)
                .attr("cx", function (d) { return d[0]; })
                .attr("cy", function (d) { return d[1]; });

            svg.selectAll("circle.preview")
                .data(previewPath)
                .enter().append("svg:circle")
                .attr("fill", "green")
                .attr("r", 3)
                .attr("cx", function (d) { return d[0]; })
                .attr("cy", function (d) { return d[1]; });
        }

        function pontoOposto(x1,y1,x2,y2){
            let x3 = 0, y3 = 0;

            let d = Math.sqrt(Math.pow((x2 - x1),2) + Math.pow((y2 - y1),2));

            let delta_x = x2 - x1;
            let delta_y = y2 - y1;
            let theta_radians = Math.atan2(delta_y, delta_x);

            x3 = x1 + (d * Math.cos(theta_radians - Math.PI));
            y3 = y1 + (d * Math.sin(theta_radians - Math.PI));

            return [x3,y3];
        }

        $("#bezierPencil").on("click", function(){
            getPoints = true;
        });
        $(document).keypress(function(event){
            let keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == '13'){
                getPoints = false;
                previewPath.pop();
                control_points.push(previewPath);
                console.log(control_points);
                previewPath = [];
                selectingPath = [];
                update();
            }

        });
        $(document).keypress(function(event){
            let keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == '27'){
                getPoints = false;
                previewPath = [];
                selectingPath = [];
                update();
            }

        });
    </script>
</body>
</html>